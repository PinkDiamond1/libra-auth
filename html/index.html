<!DOCTYPE html>
    <html>
    <head>
        <meta charset=utf-8>
        <meta name=viewport content="width=device-width, initial-scale=1">
        <title>Ticket Center</title>
        <link rel="stylesheet" href="./css/main.css">
        <style>

        </style>
        <script src="./js/libraweb-v2.js"></script>
        <script src="./js/libra-core-b.js"></script>
        <script src="./js/kulap-libra-b.js"></script>
        <script src="./js/elliptic-b.js"></script>
        <script src="./js/qrcode.min.js"></script>
        <!--script
            src="https://code.jquery.com/jquery-3.4.1.slim.min.js"
            integrity="sha256-pasqAKBDmFT4eHoN2ndd6lN370kFiGUFyTiUHWhU7k8="
            crossorigin="anonymous"></script-->>
        <script src=https://code.jquery.com/jquery-3.4.1.js></script>
        
    </head>
    <body>
        <div id=contents>
            <section>
                <img class=logo alt="libra logo" src="./img/libra.png">
            </section>    
            <header>
                <div class=header>
                        <h2>Bob's Ticket Center</h2>
                        The ticket price is <strong>10 Libra</strong>. If Buy Button click sent 10 Libra and you can take the Ticket.
                </div>
            </header>    
            <section>
                <div id=buy-button-box></div>
            </section>    
            <section>
                <div id=balance-box></div>
            </section>   

            <section>
                <div id=get-nemonic-box></div>
            </section>  

            <footer>
                <div id=info>
                    <aside>  
                    ●<br>  
                    In this demo, a client address is generated each time and 20 Libras are created and deposited.
                    If you want to store the address, save the nemonic generated by Export nemonic Button.
                    </aside>
                </div>
                <div id=powerd>
                    <nav>
                        powerd by <a href="https://github.com/toshirot/libra-auth">libra-auth method</a>
                    </nav>
                </div>
            </footer>
        </div>
        
    </body>

    <script>

$(function(){

    let debug=true

// Eventually the libraweb code will be Hide from window object later.

//=============================================================================
// main object
// 
//-----------------------------------------------------------------------------

    //------------------------------------------------------------
    // Object for Ticket Demo with Libra Auth method
    //
    // Thanx: libraweb loaded by libraweb-v2.js is browserified 
    // bandifycol/libra-web and perfectmak/libra-core.
    // Alice's client is connected to proxy ac-libra-testnet.kulap.io in kulapio/libra-core.
    let Ticket={
         libraweb: window.libraweb//Hide from window later
        ,librawebBuffer: window.librawebBuffer//Hide from window later
        ,conn: {
            wss_arry: []
            ,wss: null
            ,wsNonStopFlg:true
        }//for WebSocket
        ,clickevt: 'ontouchstart' in window ? 'touchstart' : 'click'
    };


//=============================================================================
// data
// 
//-----------------------------------------------------------------------------

    //------------------------------------------------------------
    // for LIBRA

    //In this demo Alice wallet and account is Newly made every time.
    let   AliceAddressHex=''//made every time
    let   AliceAccountOj=null//made every time
    const BOB_ADDRESS_HEX='b7c811fd8f488e9c41f03a2cc1671b3a65b4638806a2ad72c96109924bde8454'
    let   BobPubKey=null;//from LIBRA
    //unit of Libra
    const LIBRA_UNIT=1000000
    //The ticket price is 10 Libra
    const TICKET_PRICE=10*LIBRA_UNIT//10*1000000 is 10 Libra
    //First mint for Alice
    const FIRST_MINT_FOR_ALICE=TICKET_PRICE*2
    //host for mint
    const DEFAULT_FAUCET_HOST='faucet.testnet.libra.org'
    //protocol for mint. http or https
    const DEFAULT_FAUCET_PROTOCOL='http' //Currently you must post it via http "DEFAULT_FAUCET_PROTOCOL" instead of https. 2019-08-27
    //default libra explorer url
    const LIBRA_EXPLORER='https://www.libravista.com/address'
    let   GET_BALANCE_TIMER=1000
    const GET_BALANCE_COUNTER_MAX=3

    //------------------------------------------------------------
    // for DOM

    //loading html
    const LOADING_HTML='<div class="loader">Loading...</div>'
    //buy button
    const BUY_BUTTON_HTML=
        `<form>
            <button id=btn-buy class="btn-buy btn">Buy</button>
        </form>`
    //get nemonic button
    const GET_NEMONIC_HTML=
        `<form>
            <button class="btn-get-nemonic btn-nemonic">Export nemonic</button>
            <!--button class="btn-import-nemonic btn-nemonic">Import nemonic</button-->
        </form>`
    //output nemonic
    const OUTPUT_NEMONIC_HTML=
        `<div class="outout-nemonic-bar outout-nemonic">
            Please backup the  24 mnemonic words.
            <button id=btn-copy-text>copy</button>
            <button id=btn-close-nemonic>close</button>
        </div>
        <form>
            <textarea id="outout-nemonic-area" class="outout-nemonic"></textarea>
        </form>`
    //------------------------------------------------------------
    // for MESSAGE
    const M_DO_YOU_BUY_CONFIRM='Do you want to buy a ticket? The Cost is Libra 20.'

    //------------------------------------------------------------
    // for WebSocket
    const HB=JSON.stringify({type:'hb'})//heartbeat
    const HEARTBEAT_INTERVAL=60000

//=============================================================================
// main 
// 
//-----------------------------------------------------------------------------

    // lets start
    main ()

    //------------------------------------------------------------
    // Works at onload
    function main (){
        // make buy button
        mkHtml('#buy-button-box', BUY_BUTTON_HTML)
        // make get-nemonic button
        mkHtml('#get-nemonic-box', GET_NEMONIC_HTML)
        // draw loading 
        $('#balance-box').html(LOADING_HTML)
        // mk new wallet
        let newWallet=getNewWallet()
        // get Alice account object
        AliceAccountOj=getNewAccountOj(newWallet)
        // set alice address
        AliceAddressHex=getNewAddressHex(AliceAccountOj)
        // mint some Libra to Allice "TICKET_PRICE*2"  //Currently you must post it via http "DEFAULT_FAUCET_PROTOCOL" instead of https. 2019-08-27
        doMint(AliceAddressHex, FIRST_MINT_FOR_ALICE)
        // get new balance of AliceAddressHex on the testnet, and show it
        getAliceBalanceInterval(FIRST_MINT_FOR_ALICE)
        //------------------------------------------------------------
        // set Event Buy Button
        setBuyButtonEvent()
        //------------------------------------------------------------
        // set Event Nemonic Button
        setExprtNemonicEvent(newWallet)
    }

//=============================================================================
// Dom operations
// 
//-----------------------------------------------------------------------------

    //------------------------------------------------------------
    // pre) mk html
    // @targetElm {string} selector for jquery e.g. '#hoge'
    // @html {string} html
    function mkHtml(targetElm, html){
        $(targetElm).html(html)
    }
    //------------------------------------------------------------
    // pre) clientプロフィールのHTMLを作る
    // @return {string} html
    function mkClientProfeel(AliceAddressHex, balance){
        return `
        <div class=youraddr><span>Your Address:</span><br>
            <a target=_blank href=${LIBRA_EXPLORER}/${AliceAddressHex}>${AliceAddressHex}</a>
        </div>
        <div class=yourbalance><span>Your Balance: </span>${balance}</div>`
    }
    //------------------------------------------------------------
    // Show alice addr and balance
    // @AliceAddressHex {string} AliceAddressHex
    // @balance {number} Alice's balance
    function showAliceAddrAndBalance(AliceAddressHex, balance){
        // show of balance
        let _balance=unitConversionToLibra(balance, 2) +' LIBRA'
        $('#balance-box').html(mkClientProfeel(AliceAddressHex, _balance))
    }

//=============================================================================
// Dom Event operations
// 
//-----------------------------------------------------------------------------


    //------------------------------------------------------------
    // 1) Works at click or tap Buy Button
    //
    function setBuyButtonEvent(){
        $('#btn-buy').bind(Ticket.clickevt, function(){
            event.preventDefault()
            // some codes for click or tap
            $(this).css({background: '#bbb'})

            //chk do you buy?
            let okbuy=checkConfirm(M_DO_YOU_BUY_CONFIRM)
            if(okbuy){
                // buy
                // 2) ALICE: Transffer Some Libra to BOB 
                transfer(AliceAccountOj, BOB_ADDRESS_HEX, TICKET_PRICE, function(fromAddrOj){
                    
                    // get Address Hex of Alice
                    let senderAddrHex=Ticket.librawebBuffer.from(fromAddrOj.address.addressBytes).toString('hex') 
                    //get accountState
                    getAccountState(senderAddrHex, function(accountState){
                        // get balance
                        balance=+accountState.balance.toString()
                        if(typeof balance==='number'){
                            $('#buy-button-box').html('2 lets go chk tx aaa')
                            //1) send alice address to bob
                            wssSend('addr', AliceAddressHex)
                            // stop Interval
                            clearInterval(GET_BALANCE_TIMER)
                            // show addr and balance
                            showAliceAddrAndBalance(AliceAddressHex, balance)
                        }
                    })
                })

                $('#buy-button-box').html(LOADING_HTML)
                let maxBalance=FIRST_MINT_FOR_ALICE-TICKET_PRICE
                getAliceBalanceInterval(maxBalance, function(balance){
                    //wssSend('addr', AliceAddressHex)
                })
            } else {
                // Not buy
                $(this).css({background: '#39298C'})
            }

        })
    }
    //------------------------------------------------------------
    // Works at click or tap Get nemonic Button
    //
    function setExprtNemonicEvent(newWallet){
        $('.btn-get-nemonic').bind(Ticket.clickevt, function(){
            event.preventDefault()
            // make output-nemonic area
            mkHtml('#get-nemonic-box', OUTPUT_NEMONIC_HTML)
            $('#outout-nemonic-area').html(newWallet.getMnemonic().toString())

            //------------------------------------------------------------
            // copy the textarea to clipboard
            $('#btn-copy-text').bind(Ticket.clickevt, function(){
                event.preventDefault()
                let textarea = document.getElementById("outout-nemonic-area")
                // select all text
                textarea.select()
                // copy
                document.execCommand("copy")
            })
            //------------------------------------------------------------
            // close nemonic box
            $('#btn-close-nemonic').bind(Ticket.clickevt, function(){
                event.preventDefault()
                mkHtml('#get-nemonic-box', GET_NEMONIC_HTML)
                setExprtNemonicEvent(newWallet)
                //$('.btn-get-nemonic').trigger(Ticket.clickevt);
            })
        })
    }

//=============================================================================
// WebSocket Operations
// 
//-----------------------------------------------------------------------------

    let wss=wssLibraAuth('wss://wss.libra-auth.com:8888/')
    window.wss=wss//
    //------------------------------------------------------------
    // pre) Connect with WebSocket
    // @url {string} target wss Server
    // @return {object} WebSocket instance
    function wssLibraAuth(url){
        let  op={
             protocol: 'wss.libra-auth.com'
            ,uid: 'wss-' +  uuidv4()
            ,hbTimeout:null
        }

        let wss = new WebSocket(url, op.protocol)
        Ticket.conn.wss_arry.push(wss)
        wss.op=op
        wss.on = function (type, fnc){
            this.addEventListener(type, fnc)
            return this
        }
        //set the Event for WebSocket
        wss
            .on('open', function(){heartbeat(wss)})
            .on('message', function(msg){onmsg(wss,msg)})
            .on('close', function clear() {
                clearTimeout(this.pingTimeout)
                console.log('closed wss:',this.op.uid)
            })

        return wss;
    }
    //------------------------------------------------------------
    // heartbeat 
    function heartbeat(wss) {
        // Start heartbeat send
        clearInterval(wss.op.hbTimeout);
        wssSend('hb');
        wss.op.hbTimeout = setInterval(() => {
            wssSend('hb');
        }, HEARTBEAT_INTERVAL);
    }
    //------------------------------------------------------------
    // pre) onmsg
    // @wss {object} WebSocket instance
    // @msg {string} stringifyd json message
    function onmsg(wss, msg){
        //console.log(0, msg.data, wss, msg)
        if(!wss)return
        if(!msg)return
        if(!msg.data)return
        let data
        try{
            data = JSON.parse(msg.data);
            if(debug)console.log('onmsg:', data.type, data)
            if(data.type==='hb'){
                //hb
            } else if(data.type==='sig'){
                console.log(3, data)
                onReceivedSigB(data, wss)
            } else {
                console.log(4, data)
            }
        } catch(e){ 
            console.error('err', e, data)
            return 
        }
    }
    window.wssDelAll=wssDelAll
    function wssDelAll(callback) {
        let wss_arry=Ticket.conn.wss_arry
        //del all wss object
        for(var i=0;i<wss_arry.length;i++){  
            console.log(i
                , 'deleted wss'
                , (wss_arry[i].op.uid||'')
                ,new Date()
            )
            wss_arry[i].close()
        }
        Ticket.conn.wss_arry=[]
        if(callback)callback()
    }
    //------------------------------------------------------------
    // wssSend send to wss server
    // @param type {object} type e.g. 'hb'|'addr'
    // @param data {any} The object to send
    function wssSend(type, data){
        let wss=window.wss
        if(wss.readyState!==WebSocket.OPEN){
            //
        } else {
            if(type==='hb'){
                wss.send(HB)
            } else {
                wss.send(
                    JSON.stringify({
                        type: type,
                        data: data
                    })
                )
            }
        }
    }
    //------------------------------------------------------------
    // 6) Event executed when an sigB is received from the server
    // @data {object} sigB and msg {type:'sig', data:[sigB, msgHash]}
    async function onReceivedSigB(data, wss){
        console.log('onReceivedSigB', data)
        if(!data)return
        const sigB=data[0]
        const msgHash=data[1]
        getPubKey(AliceAddressHex, function(BobPubKey){
            //-------------------------------------------------
            // 6. ALICE: verify {bool} BobPubKey.verify(msg, sigB)
            const res7 = BobPubKey.verify(msgHash, sigB)
    
            //-------------------------------------------------
            // 7. ALICE: 
            if(res7===true){
                console.info('8. OK. verify(msg, sigB) is true.',)
                
            } else {
                console.error('8. Error. verify(msg, sigB) is false.')
            }
        })
    }

//=============================================================================
// QR Function
// 
//-----------------------------------------------------------------------------

    //------------------------------------------------------------
    // pre) mk and show QR code
    // @targetElm {string} selector for jquery e.g. '#hoge'
    // @return {object} QRCode Object
    function showQR(targetElm, text){
        return  new QRCode(
            $(targetElm), {
                 text: text
                ,width: 128
                ,height: 128
                ,colorDark : "#000"
                ,colorLight : "#fff"
                ,correctLevel : QRCode.CorrectLevel.H
        });
    }

//=============================================================================
// Util Functions
// 
//-----------------------------------------------------------------------------

    //------------------------------------------------------------
    // unit Conversion To Libra
    // @balance {number} libra balance
    // @decimalDigits {number} Decimal digits
    // @return {String} LIBRA
    function unitConversionToLibra(balance, decimalDigits){
        return (balance/LIBRA_UNIT).toFixed(decimalDigits)
    }

    //------------------------------------------------------------
    // 3) get getPubKey
    // @addrees {number} libra addrees
    // @callback{function} callback
    function getPubKey(fromAddress, callback){

        //for bobs tx
        sequence=0
        fetch_events=false

        let url=`https://api-test.libexplorer.com/api?module=account&action=txlist&address=${BOB_ADDRESS_HEX}`
        fetch(url, {
            method: 'get',
            mode: 'no-cors',
            headers: {
                "Content-Type": "application/json"
                ,"sec-fetch-mode": "navigate"
            }
        }).then(data  => {
            console.log(data)
            let publicKey=seachSender(fromAddress, data)
            if(callback)callback(publicKey)
        }).catch(error => console.error(error))

        //https://api-test.libexplorer.com/api?module=account&action=txlist&address=4debfa90ca96d014cecdc1ba71da0896c15e933740b1c632c1775c987f2ef4fb
        function seachSender(fromAddress, data){
            for(let i in data){
                if(data[i].result.from===fromAddress){
                    return data[i].result.publicKey
                }
            }
        }
    }

    //------------------------------------------------------------
    // pre) clientを作る
    // @return {string} addres hex
    function createClient(){
        let address=''

        return address
    }

    //------------------------------------------------------------
    // pre) onload時にここでは事前にmintで入金する
    // @address {number} libra address
    // @amount {number} libra amount
    function doMint(address, amount, host, protocol){

        if(!chkInput())return
        if(!host)host=DEFAULT_FAUCET_HOST
        if(!protocol)protocol=DEFAULT_FAUCET_PROTOCOL

        let url=`http://${host}?amount=${amount}&address=${address}`
        fetch(url, {
            method: 'post',
            mode: 'no-cors'
        }).then(data  => {
            //
        }).catch(error => console.error(error))

        function chkInput(){
            //simple check input
            if(!address){
                alert('address is required.')
                return false
            }
            try{amount=+amount}catch(e){
                alert('amount must be Number')
                return false
            }
            //if(amount>TICKET_PRICE){ alert('amount is over 10 Libra. \n amount:'+amount+'/ '+TICKET_PRICE); return false }
            return true
        }
    }
    //------------------------------------------------------------
    // pre) get balance of address
    // @address {string} target address
    // @callback{function} callback
    function getBalance(address, callback){
        getAccountState(address, function(value){
            if(callback)callback(value.balance)
        })
    }
    //------------------------------------------------------------
    // pre) get last sequenceNumber of address
    // @address {string} target address
    // @callback{function} callback
    function getLastSequenceNumber(address, callback){
        getAccountState(address, function(value){
            if(callback)callback(value.sequenceNumber)
        })
    }
    //------------------------------------------------------------
    // pre) get AccountState of address
    // @address {string} target address
    // @callback{function} callback
    function getAccountState(address, callback){
        const client = new Ticket.libraweb.LibraClient({
                protocol: 'https',
                host: 'ac-libra-testnet.kulap.io',
                port: '443',
               // dataProtocol: 'grpc-web-text'
        })
        const addr = new Ticket.libraweb.AccountAddress(
            Uint8Array.from(
                Ticket.librawebBuffer.from(address, 'hex')
            )
        )
        const accountState = 
            client
                .getAccountState(addr)
                .then((value) => {
                    if(callback)callback(value)
                }, (reason) => {
                    console.log('error:',reason)
                })
    }
    //------------------------------------------------------------
    //
    function getAliceBalanceInterval(MAX, callback){
        let getBalanceCounter=0;
        clearInterval(GET_BALANCE_TIMER)
        GET_BALANCE_TIMER=setInterval(function(){
            if( getBalanceCounter>=GET_BALANCE_COUNTER_MAX){
                console.log('---')
                clearInterval(GET_BALANCE_TIMER)
                if(callback)callback('-')
            }
           
            _getBalance(AliceAddressHex, callback)
            getBalanceCounter++;
        },1000)

        function _getBalance(AliceAddressHex, callback){
            getBalance(AliceAddressHex, function(balance){
                if(balance<=(MAX)){
                    clearInterval(GET_BALANCE_TIMER)
                    if(callback)callback(balance)
                }
                // show addr and balance
                showAliceAddrAndBalance(AliceAddressHex, balance)
            })
        }
    }
    //------------------------------------------------------------
    // pre) make new Wallet
    // @retuen {string} new wallet
    function getNewWallet(){
        return libraweb.LibraWallet.create()
    }
    //------------------------------------------------------------
    // pre) make new Alice Account oj
    // In this demo Alice wallet and account and address is Newly made every time
    // @wallet{object} wallet
    // @retuen {string} new address
    function getNewAccountOj(wallet){
        return  wallet.getAccount(0)
    }
    //------------------------------------------------------------
    // pre) make new Alice Account Hex
    // In this demo Alice wallet and account and address is Newly made every time
    // @account{object} account
    // @retuen {string} new address
    function getNewAddressHex(account){
        return account.getAddress().toHex()
    }
    //------------------------------------------------------------
    // 1) Buy buttonを押したときに送金の意志を確認する
    // @msg {string} massage
    // @retuen {Bool} true|false
    function checkConfirm(msg){
        return window.confirm(msg)
    }
    //------------------------------------------------------------
    // 2) from address から to addressへ送金する
    // @fromAddrOj {object} libra from address
    // @toAddrHex  {string} libra to address
    // @amount {number} libra amount
    async function transfer(fromAddrOj, toAddrHex, amount, callback){
        const client = new kulaplibra.LibraClient({
            transferProtocol: 'https',
            host: 'ac-libra-testnet.kulap.io',
            port: '443',
            dataProtocol: 'grpc-web-text'
        })
        const response = await client.transferCoins(fromAddrOj, toAddrHex, amount)
        //let res = await response.awaitConfirmation(client);
 
        if(callback)callback(fromAddrOj)
    }
    //------------------------------------------------------------
    // 3) 最新のシークエンス番号を取得する
    // @addrees {number} libra addrees
    // @return sequence{string} string of last sequence number
    function getLastSequence(client, addrees){
        const accountState = client.getAccountState(addrees)
        return accountState.sequenceNumber.toString()
    }
    //------------------------------------------------------------
    // 3) get transaction
    // @addrees {number} libra addrees
    // @sequence{number} sequence number
    // @fetch_events{Bool} fetch event? true|false 
    // @return {object} transaction
    function getTx(addrees, sequence, fetch_events){
        if(!fetch_events)fetch_events=false
        //get tx from testnet by libra-core
        return CLIENT.getAccountTransaction(addrees, sequence, fetch_events);
        /* return transaction object
            LibraSignedTransactionWithProof {
            signedTransaction: LibraSignedTransaction {
                transaction: LibraTransaction {
                program: [Object],
                gasContraint: [Object],
                expirationTime: [BigNumber],
                sendersAddress: [AccountAddress],
                sequenceNumber: [BigNumber]
                },
                publicKey: Uint8Array [Array],
                signature: Uint8Array [Array]
            },
            proof: {
                wrappers_: { '1': [Object], '2': [Object] },
                messageId_: undefined,
                arrayIndexOffset_: -1,
                array: [ [Array], [Array] ],
                pivot_: 1.7976931348623157e+308,
                convertedPrimitiveFields_: {}
            },
            events: undefined
            }
        */
    }
    //------------------------------------------------------------
    // 3) seach last transaction from bob and alice address
    // @sequence{number} sequence number
    // @clientAddr {number} client Address
    // @return {object} transaction
    function findLastTxBobAndAlic(sequence, clientAddr){
        let tx
        for(let i=sequence;i<=0;i--){
            tx=null; tx=getTx(alice, sequence, false)

            //chk alice bob balance これで特定してよいか
            console.log(getPubKey(transaction))
        }

        return tx
    }
    //------------------------------------------------------------
    // 3) pubKeyを取得する
    // @transaction {object} transaction 
    // @return {string} pubKey Hex
    function getPubKeyByTx(transaction){
        return transaction.signedTransaction.publicKey
    }
    //------------------------------------------------------------
    // 5) メッセージのハッシュを取得する
    // @msg {string} message
    // @return msg hash{string} msg hash by SHA3
    function mkMsgHash(msg){
        return  (new SHA3(512)).update(msg).digest('hex')
    }
    //------------------------------------------------------------
    // 5)7) メッセージと秘密鍵絵でシグネチャを生成する
    // @msg {string} message
    // @prikey {string} Private key
    // @return msg hash{string} msg hash by SHA3
    function mkMsgHash(msg, prikey){
        return prikey.sign(msg).toHex()
    }
    //------------------------------------------------------------
    // 5) WebSocketでsignatureとmassageを送る
    // @msg {string} message
    // @sig {string} signature
    function sendMsgAndSig(msg, sig){
        const data={
             msg: msg
            ,sig: sig
        }
        wssSend('sig', data)
    }
    //------------------------------------------------------------
    // 6)8) メッセージとシグネチャを公開鍵で検証する
    // @msg {string} message
    // @sig {string} signature
    // @pubkey {string} Public key
    // @return {bool} true|false
    function mkMsgHash(msg, sig, pubkey){
        //
        return  pubkey.verify(msg, sig)
    }
    //------------------------------------------------------------
    // 7) QRコードを生成する
    // @sig {string} signature
    // @return qr {Image} QR png image for of sig
    function mkMsgHash(sig){
        return  //qr
    }

    // -----------------------------------------------------------------------------
    // uuidv4
    //
    function uuidv4() {
        // Thanx for
        // https://gist.github.com/jcxplorer/823878
        // https://web.archive.org/web/20150201084235/http://blog.snowfinch.net/post/3254029029/uuid-v4-js

        let uuid = ''
        let random;
        for (let i = 0; i < 32; i++) {
            random = Math.random() * 16 | 0;
            if (i == 8 || i == 12 || i == 16 || i == 20) {
                uuid += '-';
            }
            uuid += (i == 12 ? 4 : (i == 16 ? (random & 3 | 8) : random)).toString(16);
        }
        setTimeout(function() {
            uuid=random=null;
        }, 1000);
        return uuid;
    }

})
    </script>
</html>