<!DOCTYPE html>
    <html>
    <head>
        <meta charset=utf-8>
        <meta name=viewport content="width=device-width, initial-scale=1">
        <title>Ticket Center</title>
        <link rel="stylesheet" href="./css/main.css">
        <style>

        </style>
        <script src="./js/libraweb-v2.js"></script>
        <script src="./js/libra-core-b.js"></script>
        <script src="./js/kulap-libra-b.js"></script>
        <script src="./js/elliptic-b.js"></script>
        <script src="./js/qrcode.min.js"></script>
        <script
            src="https://code.jquery.com/jquery-3.4.1.slim.min.js"
            integrity="sha256-pasqAKBDmFT4eHoN2ndd6lN370kFiGUFyTiUHWhU7k8="
            crossorigin="anonymous"></script>
        
    </head>
    <body>
        <div id=contents>
            <section>
                <img class=logo alt="libra logo" src="./img/libra.png">
            </section>    
            <header>
                <div class=header>
                        <h2>Bob's Ticket Center</h2>
                        The ticket price is <strong>10 Libra</strong>. If Buy Button click sent 10 Libra and you can take the Ticket.
                </div>
            </header>    
            <section>
                <div id=buy-button-box></div>
            </section>    
            <section>
                <div id=balance-box></div>
            </section>   

            <section>
                <div id=get-nemonic-box></div>
            </section>  

            <footer>
                <div id=info>
                    <aside>  
                    ●<br>  
                    In this demo, a client address is generated each time and 20 Libras are created and deposited.
                    If you want to store the address, save the nemonic generated by Export nemonic Button.
                    </aside>
                </div>
                <div id=powerd>
                    <nav>
                        powerd by <a href="https://github.com/toshirot/libra-auth">libra-auth method</a>
                    </nav>
                </div>
            </footer>
        </div>
        
    </body>

    <script>

$(function(){

    let debug=true

// Eventually the libraweb code will be Hide from window object later.

//=============================================================================
// main object
// 
//-----------------------------------------------------------------------------

    //------------------------------------------------------------
    // Object for Ticket Demo with Libra Auth method
    //
    // Thanx: libraweb loaded by libraweb-v2.js is browserified 
    // bandifycol/libra-web and perfectmak/libra-core.
    // Alice's client is connected to proxy ac-libra-testnet.kulap.io in kulapio/libra-core.
    let Ticket={
         libraweb: window.libraweb//Hide from window later
        ,librawebBuffer: window.librawebBuffer//Hide from window later
        ,conn: {
            wss_arry: []
            ,wss: null
            ,wsNonStopFlg:true
        }//for WebSocket
        ,clickevt: 'ontouchstart' in window ? 'touchstart' : 'click'
    };


//=============================================================================
// data
// 
//-----------------------------------------------------------------------------

    //------------------------------------------------------------
    // for LIBRA

    //In this demo Alice wallet and account is Newly made every time.
    let   AliceAddressHex=''//made every time
    let   AliceAccountOj=null//made every time
    const BOB_ADDRESS_HEX='b7c811fd8f488e9c41f03a2cc1671b3a65b4638806a2ad72c96109924bde8454'
    let   BobPubKeyOj=null;//from LIBRA
    //unit of Libra
    const LIBRA_UNIT=1000000
    //The ticket price is 10 Libra
    const TICKET_PRICE=10*LIBRA_UNIT//10*1000000 is 10 Libra
    //First mint for Alice
    const FIRST_MINT_FOR_ALICE=TICKET_PRICE*2
    //host for mint
    const DEFAULT_FAUCET_HOST='faucet.testnet.libra.org'
    //protocol for mint. http or https
    const DEFAULT_FAUCET_PROTOCOL='http' //Currently you must post it via http "DEFAULT_FAUCET_PROTOCOL" instead of https. 2019-08-27
    //default libra explorer url
    const LIBRA_EXPLORER='https://www.libravista.com/address'
    let   GET_BALANCE_TIMER=1000
    const GET_BALANCE_COUNTER_MAX=3

    //------------------------------------------------------------
    // for DOM

    //loading html
    const LOADING_HTML='<div class="loader">Loading...</div>'
    //buy button
    const BUY_BUTTON_HTML=
        `<form>
            <button id=btn-buy class="btn-buy btn">Buy</button>
        </form>`
    //get nemonic button
    const GET_NEMONIC_HTML=
        `<form>
            <button class="btn-get-nemonic btn-nemonic">Export nemonic</button>
            <!--button class="btn-import-nemonic btn-nemonic">Import nemonic</button-->
        </form>`
    //output nemonic
    const OUTPUT_NEMONIC_HTML=
        `<div class="outout-nemonic-bar outout-nemonic">
            Please backup the  24 mnemonic words.
            <button id=btn-copy-text>copy</button>
            <button id=btn-close-nemonic>close</button>
        </div>
        <form>
            <textarea id="outout-nemonic-area" class="outout-nemonic"></textarea>
        </form>`
    //------------------------------------------------------------
    // for MESSAGE
    const M_DO_YOU_BUY_CONFIRM='Do you want to buy a ticket? The Cost is Libra 20.'

    //------------------------------------------------------------
    // for WebSocket
    const HB=JSON.stringify({type:'hb'})//heartbeat
    const HEARTBEAT_INTERVAL=60000

//=============================================================================
// main 
// 
//-----------------------------------------------------------------------------

    // lets start
    main ()

    //------------------------------------------------------------
    // Works at onload
    function main (){
        // make buy button
        mkHtml('#buy-button-box', BUY_BUTTON_HTML)
        // make get-nemonic button
        mkHtml('#get-nemonic-box', GET_NEMONIC_HTML)
        // draw loading 
        $('#balance-box').html(LOADING_HTML)
        // mk new wallet
        let newWallet=getNewWallet()
        // get Alice account object
        AliceAccountOj=getNewAccountOj(newWallet)
        // set alice address
        AliceAddressHex=getNewAddressHex(AliceAccountOj)
        // mint some Libra to Allice "TICKET_PRICE*2"  //Currently you must post it via http "DEFAULT_FAUCET_PROTOCOL" instead of https. 2019-08-27
        doMint(AliceAddressHex, FIRST_MINT_FOR_ALICE)
        // get new balance of AliceAddressHex on the testnet, and show it
        getAliceBalanceInterval(FIRST_MINT_FOR_ALICE)
        //------------------------------------------------------------
        // set Event Buy Button
        setBuyButtonEvent()
        //------------------------------------------------------------
        // set Event Nemonic Button
        setExprtNemonicEvent(newWallet)
    }

//=============================================================================
// Dom operations
// 
//-----------------------------------------------------------------------------

    //------------------------------------------------------------
    // pre) mk html
    // @targetElm {string} selector for jquery e.g. '#hoge'
    // @html {string} html
    function mkHtml(targetElm, html){
        $(targetElm).html(html)
    }
    //------------------------------------------------------------
    // pre) clientプロフィールのHTMLを作る
    // @return {string} html
    function mkClientProfeel(AliceAddressHex, balance){
        return `
        <div class=youraddr><span>Your Address:</span><br>
            <a target=_blank href=${LIBRA_EXPLORER}/${AliceAddressHex}>${AliceAddressHex}</a>
        </div>
        <div class=yourbalance><span>Your Balance: </span>${balance}</div>`
    }
    //------------------------------------------------------------
    // Show alice addr and balance
    // @AliceAddressHex {string} AliceAddressHex
    // @balance {number} Alice's balance
    function showAliceAddrAndBalance(AliceAddressHex, balance){
        // show of balance
        let _balance=unitConversionToLibra(balance, 2) +' LIBRA'
        $('#balance-box').html(mkClientProfeel(AliceAddressHex, _balance))
    }

//=============================================================================
// Dom Event operations
// 
//-----------------------------------------------------------------------------


    //------------------------------------------------------------
    // 1) Works at click or tap Buy Button
    //
    function setBuyButtonEvent(){
        $('#btn-buy').bind(Ticket.clickevt, function(){
            event.preventDefault()
            // some codes for click or tap
            $(this).css({background: '#bbb'})

            //chk do you buy?
            let okbuy=checkConfirm(M_DO_YOU_BUY_CONFIRM)
            if(okbuy){
                // buy
                // 2) ALICE: Transffer Some Libra to BOB 
                transfer(AliceAccountOj, BOB_ADDRESS_HEX, TICKET_PRICE, function(fromAddrOj){

                    //-------------------------------------------------
                    // 3) ALICE: get BOB's PublicKey from testnet transaction
                    getBobPubKeyHex(function(BobPubKeyHex){
                        BobPubKeyOj = ec.keyFromPublic(BobPubKeyHex, 'hex');
                    })
                    
                    // get Address Hex of Alice
                    let senderAddrHex=Ticket.librawebBuffer.from(fromAddrOj.address.addressBytes).toString('hex') 
                    //get accountState
                    getAccountState(senderAddrHex, function(accountState){
                        // get balance
                        balance=+accountState.balance.toString()
                        if(typeof balance==='number'){
                            $('#buy-button-box').html('2 lets go chk tx aaa')
                            //1) send alice address to bob
                            wssSend('addr', AliceAddressHex)
                            // stop Interval
                            clearInterval(GET_BALANCE_TIMER)
                            // show addr and balance
                            showAliceAddrAndBalance(AliceAddressHex, balance)
                        }
                    })
                })

                $('#buy-button-box').html(LOADING_HTML)
                let maxBalance=FIRST_MINT_FOR_ALICE-TICKET_PRICE
                getAliceBalanceInterval(maxBalance, function(balance){
                    //wssSend('addr', AliceAddressHex)
                })
            } else {
                // Not buy
                $(this).css({background: '#39298C'})
            }

        })
    }
    //------------------------------------------------------------
    // Works at click or tap Get nemonic Button
    //
    function setExprtNemonicEvent(newWallet){
        $('.btn-get-nemonic').bind(Ticket.clickevt, function(){
            event.preventDefault()
            // make output-nemonic area
            mkHtml('#get-nemonic-box', OUTPUT_NEMONIC_HTML)
            $('#outout-nemonic-area').html(newWallet.getMnemonic().toString())

            //------------------------------------------------------------
            // copy the textarea to clipboard
            $('#btn-copy-text').bind(Ticket.clickevt, function(){
                event.preventDefault()
                let textarea = document.getElementById("outout-nemonic-area")
                // select all text
                textarea.select()
                // copy
                document.execCommand("copy")
            })
            //------------------------------------------------------------
            // close nemonic box
            $('#btn-close-nemonic').bind(Ticket.clickevt, function(){
                event.preventDefault()
                mkHtml('#get-nemonic-box', GET_NEMONIC_HTML)
                setExprtNemonicEvent(newWallet)
                //$('.btn-get-nemonic').trigger(Ticket.clickevt);
            })
        })
    }

//=============================================================================
// WebSocket Operations
// 
//-----------------------------------------------------------------------------

    let wss=wssLibraAuth('wss://wss.libra-auth.com:8888/')
    window.wss=wss//
    //------------------------------------------------------------
    // pre) Connect with WebSocket
    // @url {string} target wss Server
    // @return {object} WebSocket instance
    function wssLibraAuth(url){
        let  op={
             protocol: 'wss.libra-auth.com'
            ,uid: 'wss-' +  uuidv4()
            ,hbTimeout:null
        }

        let wss = new WebSocket(url, op.protocol)
        Ticket.conn.wss_arry.push(wss)
        wss.op=op
        wss.on = function (type, fnc){
            this.addEventListener(type, fnc)
            return this
        }
        //set the Event for WebSocket
        wss
            .on('open', function(){heartbeat(wss)})
            .on('message', function(msg){onmsg(wss,msg)})
            .on('close', function clear() {
                clearTimeout(this.pingTimeout)
                console.log('closed wss:',this.op.uid)
            })

        return wss;
    }
    //------------------------------------------------------------
    // heartbeat 
    function heartbeat(wss) {
        // Start heartbeat send
        clearInterval(wss.op.hbTimeout);
        wssSend('hb');
        wss.op.hbTimeout = setInterval(() => {
            wssSend('hb');
        }, HEARTBEAT_INTERVAL);
    }
    //------------------------------------------------------------
    // pre) onmsg
    // @wss {object} WebSocket instance
    // @msg {string} stringifyd json message
    function onmsg(wss, msg){
        if(!wss)return
        if(!msg)return
        if(!msg.data)return
        let data
        try{
            data = JSON.parse(msg.data);
            if(debug)console.log('onmsg:', data.type, data)
            if(data.type==='hb'){
                //hb
            } else if(data.type==='sig'){
                onReceivedSigB(data, wss)
            } else {
               
            }
        } catch(e){ 
            console.error('err', e, data)
            return 
        }
    }
    window.wssDelAll=wssDelAll
    function wssDelAll(callback) {
        let wss_arry=Ticket.conn.wss_arry
        //del all wss object
        for(var i=0;i<wss_arry.length;i++){  
            if(debug)console.log(i
                , 'deleted wss'
                , (wss_arry[i].op.uid||'')
                ,new Date()
            )
            wss_arry[i].close()
        }
        Ticket.conn.wss_arry=[]
        if(callback)callback()
    }
    //------------------------------------------------------------
    // wssSend send to wss server
    // @param type {object} type e.g. 'hb'|'addr'
    // @param data {any} The object to send
    function wssSend(type, data){
        let wss=window.wss
        if(wss.readyState!==WebSocket.OPEN){
            //
        } else {
            if(type==='hb'){
                wss.send(HB)
            } else {
                wss.send(
                    JSON.stringify({
                        type: type,
                        data: data
                    })
                )
            }
        }
    }
    //------------------------------------------------------------
    // 6) Event executed when an sigB is received from the server
    // @data {object} sigB and msg {type:'sig', data:[sigB, msgHash]}
    function onReceivedSigB(data, wss){
        if(!data.data)return
        if(data.data.length!==2)return
        const sigB=data.data[0]
        const msgHash=data.data[1]
        if(!chkDataSimple(sigB, msgHash))return
        
        if(!BobPubKeyOj){
            //-------------------------------------------------
            // 3) ALICE: get BOB's PublicKey from testnet transaction
            getBobPubKeyHex(function(BobPubKeyHex){
                BobPubKeyOj = ec.keyFromPublic(BobPubKeyHex, 'hex');
                do6and7(BobPubKeyOj, msgHash, sigB)
            })
        } else {
                do6and7(BobPubKeyOj, msgHash, sigB)
        }
        function do6and7(BobPubKeyOj, msgHash, sigB){
            //-------------------------------------------------
            // 6. ALICE: verify {bool} BobPubKeyOj.verify(msg, sigB)
            const res7 = BobPubKeyOj.verify(msgHash, sigB)
            //-------------------------------------------------
            // 7. ALICE: 
            if(res7===true){
                if(debug)console.info('8. OK. verify(msg, sigB) is true.',)
                
            } else {
                if(debug)console.error('8. Error. verify(msg, sigB) is false.')
            }
        }
        function chkDataSimple(sigB, msgHash){
            if(!sigB)return
            if(!msgHash)return
            if(sigB.length!==128)return
            if(msgHash.length!==128)return
            return true
        } 
    }

//=============================================================================
// QR Function
// 
//-----------------------------------------------------------------------------

    //------------------------------------------------------------
    // pre) mk and show QR code
    // @targetElm {string} selector for jquery e.g. '#hoge'
    // @return {object} QRCode Object
    function showQR(targetElm, text){
        return  new QRCode(
            $(targetElm), {
                 text: text
                ,width: 128
                ,height: 128
                ,colorDark : "#000"
                ,colorLight : "#fff"
                ,correctLevel : QRCode.CorrectLevel.H
        });
    }

//=============================================================================
// Util Functions
// 
//-----------------------------------------------------------------------------

    //------------------------------------------------------------
    // unit Conversion To Libra
    // @balance {number} libra balance
    // @decimalDigits {number} Decimal digits
    // @return {String} LIBRA
    function unitConversionToLibra(balance, decimalDigits){
        return (balance/LIBRA_UNIT).toFixed(decimalDigits)
    }
    //------------------------------------------------------------
    // 3) get BobPubKeyHex //In ths demo this response is Stub.

    // In the future, if possible I really want to get to the official libra.org proxy that can be trusted directly from the browse
    // Because i think there is a risk that such an important connection goes through a un offical proxy.

    // @callback{function} callback
    function getBobPubKeyHex(callback){

        let url=`http://libra-auth.com:3000/api/pubkey/${BOB_ADDRESS_HEX}`
        url='http://libra-auth.com:3000/api/pubkey/b7c811fd8f488e9c41f03a2cc1671b3a65b4638806a2ad72c96109924bde8454'
        xhr = new XMLHttpRequest()
        get()
        function get() {
            if (xhr) {
                xhr.open('GET', url, true)
               // xhr.setRequestHeader('X-PINGOTHER', 'pingpong')
                xhr.withCredentials = true
                xhr.onreadystatechange = function(){
                    if(xhr.status===200){
                         //e.g. {"type":"pubkey","key":"36506166e7e95d4bcffb2a23334df63f36d3e11aed5ad689524fb6f8d3e80ec2"}
                        let res=JSON.parse(xhr.responseText)
                        let publicKey=res.key
                        if(!publicKey)return
                        if(publicKey.length!==64)return
                        if(callback)callback(publicKey)
                    }
                }
                xhr.send(null)
            }
        }
    }
    //------------------------------------------------------------
    // pre) onload時にここでは事前にmintで入金する
    // @address {number} libra address
    // @amount {number} libra amount
    function doMint(address, amount, host, protocol){

        if(!chkInput())return
        if(!host)host=DEFAULT_FAUCET_HOST
        if(!protocol)protocol=DEFAULT_FAUCET_PROTOCOL

        let url=`http://${host}?amount=${amount}&address=${address}`
        fetch(url, {
            method: 'post',
            mode: 'no-cors'
        }).then(data  => {
            //
        }).catch(error => console.error(error))

        function chkInput(){
            //simple check input
            if(!address){
                alert('address is required.')
                return false
            }
            try{amount=+amount}catch(e){
                alert('amount must be Number')
                return false
            }
            //if(amount>TICKET_PRICE){ alert('amount is over 10 Libra. \n amount:'+amount+'/ '+TICKET_PRICE); return false }
            return true
        }
    }
    //------------------------------------------------------------
    // pre) get balance of address
    // @address {string} target address
    // @callback{function} callback
    function getBalance(address, callback){
        getAccountState(address, function(value){
            if(callback)callback(value.balance)
        })
    }
    //------------------------------------------------------------
    // pre) get AccountState of address
    // @address {string} target address
    // @callback{function} callback
    function getAccountState(address, callback){
        const client = new Ticket.libraweb.LibraClient({
                protocol: 'https',
                host: 'ac-libra-testnet.kulap.io',
                port: '443',
               // dataProtocol: 'grpc-web-text'
        })
        const addr = new Ticket.libraweb.AccountAddress(
            Uint8Array.from(
                Ticket.librawebBuffer.from(address, 'hex')
            )
        )
        const accountState = 
            client
                .getAccountState(addr)
                .then((value) => {
                    if(callback)callback(value)
                }, (reason) => {
                    console.log('error:',reason)
                })
    }
    //------------------------------------------------------------
    //
    function getAliceBalanceInterval(MAX, callback){
        let getBalanceCounter=0;
        clearInterval(GET_BALANCE_TIMER)
        GET_BALANCE_TIMER=setInterval(function(){
            if( getBalanceCounter>=GET_BALANCE_COUNTER_MAX){
                console.log('---')
                clearInterval(GET_BALANCE_TIMER)
                if(callback)callback('-')
            }
           
            _getBalance(AliceAddressHex, callback)
            getBalanceCounter++;
        },1000)

        function _getBalance(AliceAddressHex, callback){
            getBalance(AliceAddressHex, function(balance){
                if(balance<=(MAX)){
                    clearInterval(GET_BALANCE_TIMER)
                    if(callback)callback(balance)
                }
                // show addr and balance
                showAliceAddrAndBalance(AliceAddressHex, balance)
            })
        }
    }
    //------------------------------------------------------------
    // pre) make new Wallet
    // @retuen {string} new wallet
    function getNewWallet(){
        return libraweb.LibraWallet.create()
    }
    //------------------------------------------------------------
    // pre) make new Alice Account oj
    // In this demo Alice wallet and account and address is Newly made every time
    // @wallet{object} wallet
    // @retuen {string} new address
    function getNewAccountOj(wallet){
        return  wallet.getAccount(0)
    }
    //------------------------------------------------------------
    // pre) make new Alice Account Hex
    // In this demo Alice wallet and account and address is Newly made every time
    // @account{object} account
    // @retuen {string} new address
    function getNewAddressHex(account){
        return account.getAddress().toHex()
    }
    //------------------------------------------------------------
    // 1) Buy buttonを押したときに送金の意志を確認する
    // @msg {string} massage
    // @retuen {Bool} true|false
    function checkConfirm(msg){
        return window.confirm(msg)
    }
    //------------------------------------------------------------
    // 2) from address から to addressへ送金する
    // @fromAddrOj {object} libra from address
    // @toAddrHex  {string} libra to address
    // @amount {number} libra amount
    async function transfer(fromAddrOj, toAddrHex, amount, callback){
        const client = new kulaplibra.LibraClient({
            transferProtocol: 'https',
            host: 'ac-libra-testnet.kulap.io',
            port: '443',
            dataProtocol: 'grpc-web-text'
        })
        const response = await client.transferCoins(fromAddrOj, toAddrHex, amount)
        //let res = await response.awaitConfirmation(client);
 
        if(callback)callback(fromAddrOj)
    }
    //------------------------------------------------------------
    // 5) WebSocketでsignatureとmassageを送る
    // @msg {string} message
    // @sig {string} signature
    function sendMsgAndSig(msg, sig){
        const data={
             msg: msg
            ,sig: sig
        }
        wssSend('sig', data)
    }
    //------------------------------------------------------------
    // 7) QRコードを生成する
    // @sig {string} signature
    // @return qr {Image} QR png image for of sig
    function mkQR(sig){
        return  //qr
    }

    // -----------------------------------------------------------------------------
    // uuidv4
    //
    function uuidv4() {
        // Thanx for
        // https://gist.github.com/jcxplorer/823878
        // https://web.archive.org/web/20150201084235/http://blog.snowfinch.net/post/3254029029/uuid-v4-js

        let uuid = ''
        let random;
        for (let i = 0; i < 32; i++) {
            random = Math.random() * 16 | 0;
            if (i == 8 || i == 12 || i == 16 || i == 20) {
                uuid += '-';
            }
            uuid += (i == 12 ? 4 : (i == 16 ? (random & 3 | 8) : random)).toString(16);
        }
        setTimeout(function() {
            uuid=random=null;
        }, 1000);
        return uuid;
    }

})
    </script>
</html>